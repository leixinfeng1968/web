<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>初中数学 - 同类项消消乐 (计分版)</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 800px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.5s ease;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        /* 登录界面样式 */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        #login-screen input {
            padding: 12px 20px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            width: 70%;
            outline: none;
            text-align: center;
        }

        /* 游戏界面样式 */
        #game-screen {
            display: none; /* 初始隐藏 */
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .score-box, .time-box, .name-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 15px;
            border-radius: 50px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        #game-board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            perspective: 1000px;
            margin-top: 20px;
        }

        .card {
            background: white;
            color: #333;
            border-radius: 10px;
            padding: 20px 10px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.3s ease, background 0.3s ease;
            user-select: none;
            position: relative;
            transform-style: preserve-3d;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card:hover {
            transform: translateY(-5px);
            background: #f0f0f0;
        }

        .card.active {
            background: #ffeb3b; /* 选中高亮 */
            color: #000;
        }

        .card.hidden {
            background: #ff5722; /* 消除动画色 */
            color: white;
            animation: fadeOut 0.5s forwards;
            pointer-events: none;
        }

        @keyframes fadeOut {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 0; transform: scale(0); height: 0; padding: 0; margin: 0; }
        }

        .btn {
            background: #ff5722;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 10px rgba(255, 87, 34, 0.4);
            margin-top: 10px;
        }

        .btn:hover {
            background: #e64a19;
            transform: scale(1.05);
        }

        /* 弹窗样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 90%;
            width: 400px;
        }

        .modal h2 {
            color: #764ba2;
            margin-bottom: 10px;
        }

        .modal .score-display {
            font-size: 3rem;
            font-weight: bold;
            color: #ff5722;
            margin: 15px 0;
        }
        
        .modal .student-name {
            font-size: 1.5rem;
            color: #666;
            margin-bottom: 5px;
        }

        .modal p {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #666;
        }

        @media (max-width: 600px) {
            #game-board {
                grid-template-columns: repeat(3, 1fr);
            }
            .card {
                font-size: 1.2rem;
                padding: 15px 5px;
                height: 80px;
            }
            h1 {
                font-size: 2rem;
            }
            #login-screen input {
                width: 90%;
            }
        }
    </style>
</head>
<body>

    <!-- 登录/准备界面 -->
    <div id="login-screen" class="container">
        <h1>同类项消消乐</h1>
        <p style="font-size: 1.2rem; margin-bottom: 10px;">请输入你的姓名开始挑战</p>
        <input type="text" id="student-name" placeholder="输入姓名..." required>
        <button class="btn" onclick="startGame()">开始游戏</button>
        <p style="margin-top: 20px; font-size: 0.9rem; color: #ddd;">
            规则：找出同类项进行消除，满分10分<br>
            注意：选错会扣分哦！
        </p>
    </div>

    <!-- 游戏主界面 -->
    <div id="game-screen" class="container">
        <div class="header-info">
            <div class="name-box">玩家: <span id="display-name">匿名</span></div>
            <div class="score-box">得分: <span id="score">0</span>/10</div>
            <div class="time-box">时间: <span id="time">60</span>s</div>
        </div>
        
        <div id="game-board">
            <!-- 卡片将由JS生成 -->
        </div>
    </div>

    <!-- 结果弹窗 -->
    <div id="result-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">挑战结束!</h2>
            <p class="student-name">玩家: <span id="modal-name"></span></p>
            <div class="score-display"><span id="final-score">0</span> <span style="font-size: 1.5rem;">/ 10</span></div>
            <p id="comment"></p>
            <button class="btn" onclick="location.reload()">返回首页</button>
        </div>
    </div>

    <script>
        // 全局变量
        const loginScreen = document.getElementById('login-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameBoard = document.getElementById('game-board');
        const scoreElement = document.getElementById('score');
        const timeElement = document.getElementById('time');
        const nameElement = document.getElementById('display-name');
        const modal = document.getElementById('result-modal');
        const finalScoreElement = document.getElementById('final-score');
        const modalNameElement = document.getElementById('modal-name');
        const commentElement = document.getElementById('comment');

        let studentName = '';
        let score = 0;
        let timeLeft = 60;
        let selectedCards = [];
        let matchedPairs = 0;
        let totalPairs = 8; // 总共8对卡片
        let isProcessing = false;
        let timerInterval;

        // 1. 开始游戏流程
        function startGame() {
            const input = document.getElementById('student-name');
            studentName = input.value.trim();

            if (!studentName) {
                alert('请输入你的姓名！');
                return;
            }

            // 切换界面
            loginScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            nameElement.innerText = studentName;
            modalNameElement.innerText = studentName;

            // 初始化游戏数据
            initGameData();
        }

        // 2. 初始化游戏数据和卡片
        function initGameData() {
            score = 0;
            timeLeft = 60;
            matchedPairs = 0;
            selectedCards = [];
            scoreElement.innerText = score;
            timeElement.innerText = timeLeft;
            
            const cardsData = [];
            
            // 生成 8 对不同的同类项
            for(let i=0; i<totalPairs; i++) {
                const term = generateTerm();
                // 添加两张卡片
                cardsData.push({...term, id: i * 2});
                cardsData.push({...term, id: i * 2 + 1});
            }

            // 打乱数组
            shuffleArray(cardsData);

            // 渲染卡片
            renderCards(cardsData);
            
            // 开始计时
            startTimer();
        }

        // 3. 生成随机单项式
        function generateTerm() {
            const coefficients = [-9, -8, -7, -6, -5, -4, -3, -2, -1, 1, 2, 3, 4, 5, 6, 7, 8, 9];
            const variables = ['x', 'y', 'z'];
            
            const hasCoeff = Math.random() > 0.3; 
            const coeff = hasCoeff ? coefficients[Math.floor(Math.random() * coefficients.length)] : '';
            
            const varCount = Math.random() > 0.5 ? 1 : 2;
            let vars = '';
            const usedVars = new Set();
            
            for(let i=0; i<varCount; i++) {
                let v;
                do {
                    v = variables[Math.floor(Math.random() * variables.length)];
                } while(usedVars.has(v));
                usedVars.add(v);
                vars += v;
            }

            let exp = '';
            if(varCount === 1) {
                const exponents = ['', '²', '³']; 
                exp = exponents[Math.floor(Math.random() * exponents.length)];
            }

            // 特殊处理显示文本
            let displayText = '';
            if(coeff === 1 && vars) {
                displayText = vars + exp;
            } else if(coeff === -1 && vars) {
                displayText = '-' + vars + exp;
            } else {
                displayText = coeff + vars + exp;
            }

            // 生成用于判断的Key (标准化)
            const sortedVars = vars.split('').sort().join(''); 
            const key = sortedVars + (exp === '²' ? '2' : exp === '³' ? '3' : '1');

            return { display: displayText, key: key };
        }

        // 4. 渲染卡片到DOM
        function renderCards(data) {
            gameBoard.innerHTML = '';
            data.forEach(card => {
                const div = document.createElement('div');
                div.className = 'card';
                div.dataset.key = card.key;
                div.dataset.id = card.id;
                div.innerText = card.display;
                div.addEventListener('click', () => selectCard(div));
                gameBoard.appendChild(div);
            });
        }

        // 5. 卡片点击逻辑
        function selectCard(card) {
            if(isProcessing || card.classList.contains('active') || card.classList.contains('hidden')) return;

            if(selectedCards.length === 2) {
                selectedCards.forEach(c => c.classList.remove('active'));
                selectedCards = [];
            }

            card.classList.add('active');
            selectedCards.push(card);

            if(selectedCards.length === 2) {
                checkMatch();
            }
        }

        // 6. 判断匹配 (核心计分逻辑)
        function checkMatch() {
            isProcessing = true;
            const card1 = selectedCards[0];
            const card2 = selectedCards[1];

            if(card1.dataset.key === card2.dataset.key) {
                // 匹配成功
                setTimeout(() => {
                    card1.classList.add('hidden');
                    card2.classList.add('hidden');
                    
                    // 计分逻辑：
                    // 总分10分，共8对。每对基础分 1.25。
                    // 为了避免小数，可以先算整数最后处理，或者直接加分。
                    // 这里简单处理为每次加1.25分，或者根据剩余时间有微小奖励。
                    // 为了演示直观，我们设定每对得 1.25 分。
                    score += 1.25; 
                    
                    // 限制最高分为10
                    if(score > 10) score = 10;
                    
                    scoreElement.innerText = score.toFixed(1); // 保留一位小数显示
                    
                    matchedPairs++;
                    selectedCards = [];
                    isProcessing = false;

                    // 检查胜利
                    if(matchedPairs === totalPairs) {
                        endGame(true);
                    }
                }, 600);
            } else {
                // 匹配失败
                setTimeout(() => {
                    card1.classList.remove('active');
                    card2.classList.remove('active');
                    selectedCards = [];
                    isProcessing = false;
                    
                    // 扣分惩罚：扣 0.5 分
                    score = Math.max(0, score - 0.5); 
                    scoreElement.innerText = score.toFixed(1);
                }, 1000);
            }
        }

        // 7. 计时器
        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timeElement.innerText = timeLeft;

                if(timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(false);
                }
            }, 1000);
        }

        // 8. 游戏结束
        function endGame(isWin) {
            clearInterval(timerInterval);
            
            // 最终得分处理：四舍五入保留一位小数
            const finalScore = Math.round(score * 10) / 10; 
            finalScoreElement.innerText = finalScore;

            if(isWin) {
                document.getElementById('modal-title').innerText = "恭喜通关!";
                commentElement.innerText = "你真是代数小天才！";
                commentElement.style.color = "#2ecc71";
            } else {
                document.getElementById('modal-title').innerText = "时间到!";
                
                // 根据分数给评语
                if(finalScore >= 9) {
                    commentElement.innerText = "分数很高，太厉害了！";
                    commentElement.style.color = "#2ecc71";
                } else if(finalScore >= 6) {
                    commentElement.innerText = "还不错，继续加油！";
                    commentElement.style.color = "#f39c12";
                } else {
                    commentElement.innerText = "需要复习一下同类项的定义哦。";
                    commentElement.style.color = "#e74c3c";
                }
            }

            modal.style.display = 'flex';
        }

        // 辅助函数：洗牌算法
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
